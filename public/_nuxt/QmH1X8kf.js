import{Et as e,G as t,Rt as n,St as r,b as i,ot as a,vt as o}from"./BLt7TXlb.js";import{c as s}from"./CreLCcZP.js";import{d as c}from"./Cr_GQgS6.js";import{p as l}from"./mPlC9-cP.js";import{n as u,t as d}from"./DQw8S1UI.js";import{i as f,n as p,r as m,t as h}from"./B_LT0yGC.js";var g=n(u(),1);function _(e){return(e.startsWith(`@`)&&e.split(`/`)[1]||e).toLowerCase().replace(/[.\-_]/g,``).replace(/^(node|js)|(-?js|-?node)$/g,``)}function v(e,t){let n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let r=1;r<=t.length;r++)for(let i=1;i<=e.length;i++)t.charAt(r-1)===e.charAt(i-1)?n[r][i]=n[r-1][i-1]:n[r][i]=Math.min(n[r-1][i-1]+1,n[r][i-1]+1,n[r-1][i]+1);return n[t.length][e.length]}function y(e){return e?(0,g.default)(e).validForNewPackages===!0:!1}async function b(e,t={}){try{return await $fetch(`${l}/${d(e)}`,{...t,method:`HEAD`}),!0}catch{return!1}}async function x(e,t={}){let n=_(e),r=[];try{let i=await $fetch(`${l}/-/v1/search?text=${encodeURIComponent(e)}&size=20`,t);for(let t of i.objects){let i=t.package.name,a=_(i);if(i===e){r.push({name:i,description:t.package.description,similarity:`exact-match`});continue}if(n===a){r.push({name:i,description:t.package.description,similarity:`very-similar`});continue}let o=v(n,a),s=Math.max(n.length,a.length);s!==0&&(1-o/s>=.8||o<=2)&&r.push({name:i,description:t.package.description,similarity:`similar`})}let a={"exact-match":0,"very-similar":1,similar:2};return r.sort((e,t)=>a[e.similarity]-a[t.similarity]),r.slice(0,10)}catch{return[]}}async function S(e,t={}){let n=(0,g.default)(e),r=n.validForNewPackages===!0,i={name:e,available:!1,valid:r};if(n.errors?.length&&(i.validationErrors=n.errors),n.warnings?.length&&(i.validationWarnings=n.warnings),!r)return i;let[a,o]=await Promise.all([b(e,t),x(e,t)]);return i.available=!a,i.similarPackages=o,i}async function C(e){try{let t=`@${e.toLowerCase()}/`;return(await $fetch(`${l}/-/v1/search`,{query:{text:`@${e}`,size:5}})).objects.some(e=>e.package.name.toLowerCase().startsWith(t))}catch{return!1}}async function w(e){try{return(await $fetch(`${l}/-/v1/search`,{query:{text:`maintainer:${e}`,size:1}})).total>0}catch{return!1}}function T(){let{$npmRegistry:e}=c();async function t(t,n={},r){if(t.length===1)try{return{objects:[m(await $fetch(`/api/registry/package-meta/${d(t)}`,{signal:r}))],total:1,isStale:!1,time:new Date().toISOString()}}catch{return p()}let i=new URLSearchParams;i.set(`text`,t),i.set(`size`,String(n.size??25)),n.from&&i.set(`from`,String(n.from));let{data:a,isStale:o}=await e(`/-/v1/search?${i.toString()}`,{signal:r},60);return{...a,isStale:o}}return{search:t,checkOrgExists:C,checkUserExists:w}}function E(){return{searchResponse:p(),suggestions:[],packageAvailability:null}}function D(n,c,l={},u={}){let{search:d,searchWithSuggestions:p}=h(),{search:m,checkOrgExists:g,checkUserExists:_}=T(),v=r(null),x=r(!1),S=r(!1),C=r([]),w=r(!1),D=r(null),O=r({}),k=r(0);function A(e){if(!u.suggestions)return;let{intent:t,name:n}=f(e),r=n.toLowerCase(),i={},a=!1;if(t&&n){let e=t===`org`||t===`both`,o=t===`user`||t===`both`;e&&O.value[`org:${r}`]===void 0&&(i.name=n,i.checkOrg=!0,a=!0),o&&O.value[`user:${r}`]===void 0&&(i.name=n,i.checkUser=!0,a=!0)}let o=e.trim();return y(o)&&(i.checkPackage=o,a=!0),a?i:void 0}function j(e,t,n){let{intent:r,name:i}=f(e);if(r&&i){let e=i.toLowerCase(),a=r===`org`||r===`both`,o=r===`user`||r===`both`,s={};t?.checkOrg&&(s[`org:${e}`]=n.orgExists),t?.checkUser&&(s[`user:${e}`]=n.userExists),Object.keys(s).length>0&&(O.value={...O.value,...s});let c=a&&O.value[`org:${e}`],l=o&&O.value[`user:${e}`],u=[];c&&u.push({type:`org`,name:e,exists:!0}),l&&!c&&u.push({type:`user`,name:e,exists:!0}),C.value=u}else C.value=[];let a=e.trim();n.packageExists!==null&&y(a)?D.value={name:a,available:!n.packageExists}:y(a)||(D.value=null),w.value=!1}let M=s(()=>`search:${e(c)}:${e(n)}`,async(t,{signal:r})=>{let i=e(n),a=e(c);if(!i.trim())return S.value=!1,E();let o=e(l);if(v.value=null,a===`algolia`){let t=u.suggestions?A(i):void 0;if(u.suggestions){w.value=!0;let r=await p(i,{size:o.size??25},t);return i===e(n)?(S.value=!1,j(i,t,r),{searchResponse:r.search,suggestions:C.value,packageAvailability:D.value}):E()}let r=await d(i,{size:o.size??25});return i===e(n)?(S.value=!1,{searchResponse:r,suggestions:[],packageAvailability:null}):E()}try{let t=await m(i,{size:o.size??25},r);return i===e(n)?(v.value={query:i,provider:a,objects:t.objects,total:t.total},S.value=!1,{searchResponse:t,suggestions:[],packageAvailability:null}):E()}catch(e){let t=e?.message||String(e);if(t.includes(`Failed to fetch`)||t.includes(`429`))return S.value=!0,E();throw e}},{default:E});async function N(t){let r=e(n).trim(),i=e(c);if(!r){v.value=null;return}if(v.value&&(v.value.query!==r||v.value.provider!==i)){v.value=null,await M.refresh();return}if(!v.value&&M.data.value){let{searchResponse:e}=M.data.value;v.value={query:r,provider:i,objects:[...e.objects],total:e.total}}let a=v.value?.objects.length??0,o=v.value?.total??1/0;if(!(a>=t||a>=o)){x.value=!0;try{let e=a,n=Math.min(t-a,o-a),s=await(i===`algolia`?d:m)(r,{size:n,from:e});if(v.value&&v.value.query===r&&v.value.provider===i){let e=new Set(v.value.objects.map(e=>e.package.name)),t=s.objects.filter(t=>!e.has(t.package.name));v.value={query:r,provider:i,objects:[...v.value.objects,...t],total:s.total}}else v.value={query:r,provider:i,objects:s.objects,total:s.total};v.value&&v.value.objects.length<t&&v.value.objects.length<v.value.total&&await N(t)}finally{x.value=!1}}}a(()=>e(l).size,async(t,r)=>{t&&r&&t>r&&e(n).trim()&&await N(t)}),a(()=>e(c),async()=>{v.value=null,O.value={},await M.refresh();let t=e(l).size;t&&await N(t)});let P=i(()=>v.value?{isStale:!1,objects:v.value.objects,total:v.value.total,time:new Date().toISOString()}:M.data.value?.searchResponse??null),F=i(()=>v.value?v.value.objects.length<v.value.total:!0);async function I(t){let r=++k.value,{intent:i,name:a}=f(t),o=null,s=[],c=t.trim();if(y(c)?s.push(b(c).then(t=>{c===e(n).trim()&&(o={name:c,available:!t},D.value=o)}).catch(()=>{o=null})):o=null,!i||!a)return w.value=!1,await Promise.all(s),{suggestions:[],packageAvailability:o};w.value=!0;let l=[],u=a.toLowerCase();try{let e=i===`org`||i===`both`,t=i===`user`||i===`both`;if(e&&O.value[`org:${u}`]===void 0&&s.push(g(u).then(e=>{O.value={...O.value,[`org:${u}`]:e}}).catch(()=>{O.value={...O.value,[`org:${u}`]:!1}})),t&&O.value[`user:${u}`]===void 0&&s.push(_(u).then(e=>{O.value={...O.value,[`user:${u}`]:e}}).catch(()=>{O.value={...O.value,[`user:${u}`]:!1}})),s.length>0&&await Promise.all(s),r!==k.value)return{suggestions:[],packageAvailability:o};let n=e&&O.value[`org:${u}`],a=t&&O.value[`user:${u}`];n&&l.push({type:`org`,name:u,exists:!0}),a&&!n&&l.push({type:`user`,name:u,exists:!0})}finally{r===k.value&&(w.value=!1)}return r===k.value?(C.value=l,{suggestions:l,packageAvailability:o}):{suggestions:[],packageAvailability:o}}let L=s(()=>`npm-suggestions:${e(c)}:${e(n)}`,async()=>{let t=e(n).trim();if(e(c)===`algolia`||!t)return{suggestions:[],packageAvailability:null};let{intent:r,name:i}=f(t);return!r||!i?{suggestions:[],packageAvailability:null}:I(t)},{default:()=>({suggestions:[],packageAvailability:null})});return a([()=>M.data.value.suggestions,()=>L.data.value.suggestions],([e,t])=>{(e.length||t.length)&&(C.value=e.length?e:t)},{immediate:!0}),a([()=>M.data.value?.packageAvailability,()=>L.data.value.packageAvailability],([e,t])=>{(e||t)&&(D.value=e||t)},{immediate:!0}),M.data.value?.searchResponse.isStale&&t(()=>{M.refresh()}),{...M,data:P,isLoadingMore:x,hasMore:F,fetchMore:N,isRateLimited:o(S),suggestions:o(C),suggestionsLoading:o(w),packageAvailability:o(D)}}export{S as n,y as r,D as t};